#!/bin/bash

# a script to build owl and some related tools periodically from scratch
# and run randomized tests in the meantime.
# you probably don't want to run this.

# restart run if i get updated
ME=$(md5sum < $0)
MYDIR=$(pwd)

WORK=$HOME/ram # normally a ramdisk, don't want to wear ssds too much
EMAIL="aohelin@gmail.com"
RELATEDPROJECTS="radamsa blab dwim spektro"

case "$(hostname)" in 
 haltp) 
   SMTP=mail.utanet.fi;
   DELAY=40 ;; # don't want to spin up fans here
 *)     
   SMTP=mail.panoulu.net ;
   DELAY=0 ;; # please do run
esac

notify() {
	mailx -S "from=Note <$(whoami)@$(hostname --long)>" -S smtp=$SMTP -s "$(echo $@)" $EMAIL
}

notify_irc() {
	echo -e "NICK $(hostname)-$$\nUSER builder 8 x $(hostname -s) $(hostname -d)\nJOIN #owl-lisp\nPRIVMSG #owl-lisp :$1\nQUIT" | nc -i 5 -q 10 irc.freenode.net 6667
}

renice +20 $$

date | notify "Builder.sh started on $(hostname)"
date | notify_irc "builder started on $(hostname) ($(uname -m), $(echo $ME | dd bs=1 count=5))"

test -d $WORK || {
   echo "work directory '$WORK' doesn't exist";
   exit 2;
}

# get part of current git version hash for identification
thisgit() {
   git log | head -n 1 | sed -e 's/.* \(......\).*/\1.../'
}

cd $WORK

echo "*** GETTING SOURCES ***"
for project in owl-lisp $RELATEDPROJECTS
do
   echo " - $project"
   test -d $project || git clone http://haltp.org/git/$project.git
done

TESTMINS=15     # minutes of random unit tests 
THEOREMS=5000   # iterations of theorem test
TIMELIMIT=3000  # max build seconds

while true
do
	cd $WORK

	echo "Build cycle on $(date)"

	## BUILD OWL

	echo " - fresh owl build"
	cd owl-lisp
	git pull
   NEWME=$(md5sum < bin/builder)
   test "$ME" = "$NEWME" || { notify_irc "I sense bin/builder has changed."; cd "$MYDIR"; git pull; exec bin/builder; }
	make clean
	VERSION=$(thisgit)
	echo building owl
	(ulimit -S -t $TIMELIMIT; make > build.log 2>&1) || { 
		# notify on first try
		echo build failed
		test "$(cat .lastbuild)" = "$VERSION" \
			|| notify_irc "aoh, clean owl build FAILED for $VERSION on $(hostname)"
		echo "$VERSION" > .lastbuild # don't talk about this one anymore
		sleep 300;
		continue; # don't try to do the rest, owl is broken
	}
	# notify if this is a new version
	test "$(cat .lastbuild)" = "$VERSION" \
		|| notify_irc "clean owl build succeeded for $VERSION on $(hostname)"
	echo $VERSION > .lastbuild


   ## BUILD RELATEDPROJECTS 

   echo "*** BUILDING SIDE PROJECTS ***"
   for project in $RELATEDPROJECTS
   do
      cd $HOME/ram
      echo " - fresh $project build"
      cd $project
      git pull
      make clean
      rm -rf owl-lisp
      cp -a ../owl-lisp .
      VERSION="$project $(thisgit), owl $(cd owl-lisp && thisgit)"
      (ulimit -S -t $TIMELIMIT; make > build.log 2>&1) || {
         test "$(cat .lastbuild)" = "$VERSION" \
            || notify_irc "aoh, $project build FAILED for $VERSION: $(cat build.log | grep ERROR | head -n 1)"
         echo "$VERSION" > .lastbuild
         notify "$project build failed on $(hostname)" < build.log;
         echo "FAIL";
      }
      test "$(cat .lastbuild)" = "$VERSION" \
         || notify_irc "build success for $VERSION"
      echo "updated version to $VERSION"
      echo $VERSION > .lastbuild
   done


   ## RANDOMIZED OWL UNIT TESTS

	cd $WORK/owl-lisp
	VERSION=$(thisgit)
	echo " - running $TESTMINS minutes of randomized unit tests"
   END=$(ol -e "(+ (time) (* $TESTMINS 60))")
   while true
   do
      LEFT=$(ol -e "(- $END (time))")
      ol -t "(< $LEFT 1)" && break
      echo " - ${LEFT}s left"
      sleep $DELAY # optional, machine-specific
		(ulimit -S -t $TIMELIMIT; make random-test > test.log 2>&1) || {
         cp test.log /tmp/test-fail-$(ol -e '(time-ms)').log;
			notify "Owl random test failed on $(hostname)" < test.log;
         notify_irc "aoh, randomized test FAILED on $(hostname) using owl $VERSION";
			sleep 600;
			continue;
		}
   done

   ## THEOREM TEST ONLY 

   SEED=$(echo -n $$; bin/ol -e '(time-ms)')
	VERSION=$(thisgit)
	echo " - running theorem test for a while with seed $SEED"
	bin/ol --run tests/theorem-rand.scm --seed $SEED -n $THEOREMS &> random.log || { cp random.log /tmp; notify_irc "aoh, theorem test FAILED on $(hostname) with seed $SEED, owl $VERSION"; }

   sleep $DELAY

done

